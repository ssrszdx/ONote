# 线程安全与非线程安全

曾经初学PHP的时候也很困惑对线程安全与非线程安全模式这块环境的选择，也未能理解其中意。近来无意中看到一个教程对线程安全（饿汉式），非线程安全（懒汉式）的描述，虽然觉得现在已经能够很明了透彻地理解这块内容，但是还是觉得很有必要整理一下以为后来者提供便利。

## 一、什么是线程安全与非线程安全？

借用网上的一段文来解释概念。

> 线程安全就是多线程访问时，采用了加锁机制，当一个线程访问该类的某个数据时，进行保护，其他线程不能进行访问直到该线程读取完，其他线程才可使用。不会出现数据不一致或者数据污染。
>
> 线程不安全就是不提供数据访问保护，有可能出现多个线程先后更改数据造成所得到的数据是脏数据。
>
> 如果你的代码所在的进程中有多个线程在同时运行，而这些线程可能会同时运行这段代码。如果每次运行结果和单线程运行的结果是一样的，而且其他的变量的值也和预期的是一样的，就是线程安全的。
>
> **线程安全问题都是由全局变量及静态变量引起的。**
>
> 若每个线程中对全局变量、静态变量只有读操作，而无写操作，一般来说，这个全局变量是线程安全的；若有多个线程同时执行写操作，一般都需要考虑线程同步，否则的话就可能影响线程安全。

啥个意思呢？小马认为，其实可以理解为这和业务逻辑上的db查改并发控制一样，只不过对db换成了对内存中的 **全局变量及静态变量。** 解决的方式自然也就是加并发锁了，只不过这里的锁不是我们加，是底层自己维护。《非线性安全[并发例子](https://links.jianshu.com/go?to=https%3A%2F%2Fblog.csdn.net%2Fleafdown_%2Farticle%2Fdetails%2F91345429)》

**先来看看JAVA对这块的描述（重点看加粗文字哈）：**

Java中线程安全和非线程安全：

1、线程安全 **主要发生在实例变量或者类变量中，不会发生在方法的局部变量** （可以通过JVM内存分布的 栈桢来解释）。

2、锁分为三类：

    a、类锁     -  静态代码块锁发生。

    b、对象锁 -  成员方法或者代码块锁发生。

    c、方法锁 - 方法上锁发生的。

## 二、PHP线程安全和非线程安全模式的选择

部分web server在处理应用请求的时候是用多线程而非多进程的方式处理，线程方式因为涉及到共享寄存器和内存，所以很容易出错，这个时候程序就需要花一些额外的经历去处理寄存器中的数据一致性，即保证线程安全。所以是否采用线程安全主要看你的web server所采用的PHP请求处理方式，如果是多线程处理，那么请选择线程安全的，否则选择非线程安全的，如楼上所说Fast-cgi方式可选择非线程安全的。

以下就直接选用网上的一段文来描述。

> 先从字面意思上理解，None-Thread Safe就是非线程安全，在执行时不进行线程（thread）安全检查；Thread Safe就是线程安全，执行时会进行线程（thread）安全检查，以防止有新要求就启动新线程的 CGI 执行方式耗尽系统资源。
>
> 再来看PHP的两种执行方式：ISAPI和FastCGI。FastCGI执行方式是以单一线程来执行操作，所以不需要进行线程的安全检查，除去线程安全检查的防护反而可以提高执行效率，所以，如果是以 FastCGI（无论搭配 IIS 6 或 IIS 7）执行 PHP ，都建议下载、执行 non-thread safe 的 PHP （PHP 的二進位檔有兩種包裝方式：msi 、zip ，請下載 zip 套件）。**而线程安全检查正是为ISAPI方式的PHP准备的，因为有许多php模块都不是线程安全的，所以需要使用Thread Safe的PHP。**
>
> 说到这里，大家应该知道应该如何选择哪个版本的PHP了。None-Thread Safe or Thread Safe，您会选择哪个？
>
> Windows下的PHP现在的版本已经是5.3.6，现在的Windows版本可以在PHP官方PHP For Windows（http://windows.php.net/download/）下载，下载的时候同版本有VC9 x86 Non Thread Safe、VC9 x86 Thread Safe、VC6 x86 Non Thread Safe、VC6 x86 Thread Safe等四个版本。那么这些版本有什么区别呢？
>
> VC9的版本是用legacy VS 2008编译的，VC6的版本是用legacy VS6编译的。
>
> 如果你是在windows下使用IIS+PHP的话，你需要下载VC9的版本。
>
> 如果你是在windows下使用Apache+PHP的话，你需要下载VC6的版本。
>
> Non Thread Safe是指非线程安全，Thread Safe则是指线程安全。

**总结：如果是使用ISAPI的方式来运行PHP就必须用Thread Safe(线程安全)的版本；而用FastCGI模式运行PHP的话就没有必要用线程安全检查了，用None Thread Safe(NTS，非线程安全)的版本能够更好的提高效率。**

当然理解线程安全和非线程安全这块知识并不只是为了解决如何选择PHP运行模式的问题，而是很多需要理解进程模型，并发编程有着重要的意义，甚至引申到协程的编码，协程间的通信通道的使用等等。
